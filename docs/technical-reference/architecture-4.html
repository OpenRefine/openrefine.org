<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-technical-reference/architecture-4" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.1">
<title data-rh="true">Architecture in version 4 | OpenRefine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openrefine.org/docs/technical-reference/architecture-4"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Architecture in version 4 | OpenRefine"><meta data-rh="true" name="description" content="This page explains the architecture of OpenRefine 4, which is currently being developed and differs from the previous versions in important ways."><meta data-rh="true" property="og:description" content="This page explains the architecture of OpenRefine 4, which is currently being developed and differs from the previous versions in important ways."><link data-rh="true" rel="icon" href="/img/openrefine_logo.svg"><link data-rh="true" rel="canonical" href="https://openrefine.org/docs/technical-reference/architecture-4"><link data-rh="true" rel="alternate" href="https://openrefine.org/docs/technical-reference/architecture-4" hreflang="en"><link data-rh="true" rel="alternate" href="https://openrefine.org/docs/technical-reference/architecture-4" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://RXJKLJKJU2-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenRefine RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenRefine Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="OpenRefine" href="/opensearch.xml">


<script src="/js/fix-location.js"></script><link rel="stylesheet" href="/assets/css/styles.a1181bf6.css">
<script src="/assets/js/runtime~main.3b2d2040.js" defer="defer"></script>
<script src="/assets/js/main.c6558953.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_hUDU" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/openrefine_logo.svg" alt="OpenRefine diamond logo" class="themedComponent_vVmS themedComponent--light_NniB"><img src="/img/openrefine_logo.svg" alt="OpenRefine diamond logo" class="themedComponent_vVmS themedComponent--dark_yJur"></div><b class="navbar__title text--truncate">OpenRefine</b></a><a class="navbar__item navbar__link" href="/download">Download</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Documentation</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/donate">Donate</a><a href="https://github.com/OpenRefine/OpenRefine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_RpKI"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_CSJf colorModeToggle_Cgdy"><button class="clean-btn toggleButton_jrrp toggleButtonDisabled_v9ww" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_hPNs"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_Pxog"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_WQyT"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_tDGm"><div class="docsWrapper_kJ9P"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_hEO2" type="button"></button><div class="docRoot_q0n7"><aside class="theme-doc-sidebar-container docSidebarContainer_HBrN"><div class="sidebarViewport_rCxN"><div class="sidebar_hGra"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_Uy8J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs">User Manual</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/technical-reference/contributing">Contributing to OpenRefine</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/contributing">Getting started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/why-get-involved">Why get involved</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/github">Communicating via GitHub</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/technical-reference/code-contributions">Contributing as a developer</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/code-contributions">Code contributions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/translating-ui">Translate OpenRefine&#x27;s interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/build-test-run">How to build, test and run</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/functional-tests">Functional tests</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/technical-reference/architecture-before-4">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/architecture-before-4">Architecture before version 4</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/technical-reference/architecture-4">Architecture in version 4</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/clustering-in-depth">Clustering methods in-depth</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/openrefine-api">OpenRefine API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/reconciliation-api">Reconciliation API</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/technical-reference/writing-extensions">Extensions</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/technical-reference/maintainer-guidelines">Maintaining OpenRefine</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/technical-reference/introduction">Contributing as a designer</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/documentation-contributions">Documentation contributions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/technical-reference/development-roadmap">Development roadmap</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_msDC"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VluO"><div class="docItemContainer_z4Sv"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_WV5T" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_xTv0"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Contributing to OpenRefine</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Contributing as a developer</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Architecture in version 4</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_d09M theme-doc-toc-mobile tocMobile__k1e"><button type="button" class="clean-btn tocCollapsibleButton_cV_m">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Architecture in version 4</h1></header><p>This page explains the architecture of OpenRefine 4, which is currently being developed and differs from the previous versions in important ways.
Projects and their history are represented differently, which makes it possible to work on tables which do not fit in RAM, improve the user experience around long-running operations in various ways
and the reproducibility of OpenRefine workflows more broadly.</p>
<h2 class="anchor anchorWithStickyNavbar__YFU" id="project-history-structure">Project history structure<a href="#project-history-structure" class="hash-link" aria-label="Direct link to Project history structure" title="Direct link to Project history structure">​</a></h2>
<p>The history of a project is a succession of different states of the project. Each state is a <a href="https://javadoc-v4.openrefine.org/org/openrefine/model/grid" target="_blank" rel="noopener noreferrer">Grid</a>, which comprises the following data:</p>
<ul>
<li>column headers, containing column metadata such as the column names;</li>
<li>the project table itself;</li>
<li>the overlay models stored alongside the table (such as a Wikibase schema).</li>
</ul>
<p>The initial grid of the project is generated by the importer which created the project.
Each following is obtained by applying a <a href="https://javadoc-v4.openrefine.org/org/openrefine/model/changes/change" target="_blank" rel="noopener noreferrer">Change</a> on the previous grid. A change is a function which takes the previous grid and produces the new grid.</p>
<p>Grids are immutable objects. This means that a change cannot mutate the grid in place: it must create a modified copy of the grid instead.
We will see in <a href="#runners">the Runners section</a> why can be done efficiently and does not require a lot of data copy in general.
The immutability of grids provides useful guarantees about thread safety. For instance, this helps ensure that the evaluation of facets happened at a precise point in project history,
and does not give a mixed view of different grid states.</p>
<p>In the previous architecture, changes were not only responsible for applying themselves to a grid, but also to revert themselves, meaning that they had to implement the reverse operation as well.
Only requiring the forward application has important consequences:</p>
<ul>
<li>Implementing a change is easier, since we only need to implement the function in one direction. Implementing both directions and making sure they were indeed inverses of each other is non-trivial and gave rise to certain bugs, such as <a href="https://github.com/OpenRefine/OpenRefine/issues/2" target="_blank" rel="noopener noreferrer">#2</a>. Because we let extensions define their own changes, there was a significant risk that an extension implements a change incorrectly, leaving the project in an inconsistent state after using the undo feature.</li>
<li>Many operations in OpenRefine are destructive, meaning that reverting them requires storing the deleted or altered data in the change object itself, to be able to restore it upon reversion. This is no longer necessary, making it possible for changes to
be much lighter;</li>
<li>To undo a change, we need to have kept the earlier version of the grid accessible. We will see in <a href="#runners">the Runners section</a> why this can be done efficiently, without keeping all grids in memory explicitly.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar__YFU" id="runners">Runners<a href="#runners" class="hash-link" aria-label="Direct link to Runners" title="Direct link to Runners">​</a></h2>
<p>The implementation of grids and of the transformations on them is pluggable. This means that the way a grid is concretely represented in memory can be adapted, depending on the resources available and the broader context of execution. This relies on the
notion of <a href="https://javadoc-v4.openrefine.org/org/openrefine/model/runner" target="_blank" rel="noopener noreferrer">Runner</a>, which is essentially a factory class for grids which picks a particular implementation of the Grid interface when creating such grids.</p>
<ul>
<li>
<p>The <a href="#local-runner">local runner</a> is the default one. It is designed to be run when all of the data to transform is located on the same machine (where OpenRefine is running). Project data is read from disk in a lazy fashion, i.e. only when the corresponding grid values need to be displayed, aggregated or exported. Therefore it makes it possible to run OpenRefine on large datasets without the need for a large working memory (RAM). We explain the differences between <a href="#lazy-and-eager-evaluation">lazy and eager evaluation</a> in the dedicated section.</p>
</li>
<li>
<p>The Spark runner is designed to run on distributed datasets. Those datasets can be split into blocks which are stored on different machines. The execution of the workflow can be shared between the various machines, which form a Spark cluster. As in the local runner, changes are evaluated lazily.</p>
</li>
<li>
<p>The testing runner is a very simple runner, which loads all the data it works on in memory. It is not optimized for performance at all: it simply meets the specification of the runner interface in the simplest possible way. It is used in tests of operations, importers and other basic blocks of workflows. Its simplicity makes it fast enough on small testing datasets generally used in such tests. This runner also performs additional checks during execution, so that incorrect behaviours can be detected more easily during testing. Unlike the local and Spark runners, the testing runner uses eager evaluation.</p>
</li>
</ul>
<p>The runner can be configured on the command-line with the <code>-r</code> option (<code>/r</code> on Windows), by providing the class name of the data model runner to use. In the <code>refine.ini</code> configuration file, the corresponding option is <code>refine.runner.class</code>.
The class names of the available runners are:</p>
<ul>
<li><a href="https://javadoc-v4.openrefine.org/org/openrefine/runners/local/localrunner" target="_blank" rel="noopener noreferrer"><code>org.openrefine.runners.local.LocalRunner</code></a> for the <a href="#local-runner">local runner</a> (default)</li>
<li><a href="https://javadoc-v4.openrefine.org/org/openrefine/runners/spark/SparkRunner" target="_blank" rel="noopener noreferrer"><code>org.openrefine.runners.spark.SparkRunner</code></a> for the Spark-based runner</li>
<li><a href="https://javadoc-v4.openrefine.org/org/openrefine/runners/testing/testingrunner" target="_blank" rel="noopener noreferrer"><code>org.openrefine.runners.testing.TestingRunner</code></a> for the testing runner</li>
</ul>
<p>A common test suite, gathering test cases that all runners should pass, is available in <a href="https://javadoc-v4.openrefine.org/org/openrefine/runners/testing/runnertestbase" target="_blank" rel="noopener noreferrer">RunnerTestBase</a>. This can be used by creating a test class which extends this base
class.</p>
<h2 class="anchor anchorWithStickyNavbar__YFU" id="lazy-and-eager-evaluation">Lazy and eager evaluation<a href="#lazy-and-eager-evaluation" class="hash-link" aria-label="Direct link to Lazy and eager evaluation" title="Direct link to Lazy and eager evaluation">​</a></h2>
<p>Given that grids are immutable, changing even just a single cell in a grid requires making a copy of that grid.
One strategy to achieve this, which is used by the testing runner, is to create a copy of all cells of the original grid, with the change on the desired cell, and return this as a new grid.
But grids do not have to be backed by a list of lists containing the value of each cell.</p>
<p>Instead, the lazy runners use a different strategy. The returned grid is a proxy object, which contains a pointer to the original grid, and implements all operations on the new grid by forwarding them to the original grid, and adapting their results to match the
ones expected of the new grid.</p>
<p>We call those runners lazy because the operations on their grids are <a href="https://en.wikipedia.org/wiki/Lazy_evaluation" target="_blank" rel="noopener noreferrer">lazily evaluated</a>: the actual computation does not happen when creating the modified grid, but is delayed to the later use of the data in
the grid (such as running an aggregation on it to compute facet statistics, or retrieving a range of rows).</p>
<p>This has a few important consequences:</p>
<ul>
<li>the proxy objects representing those transformed grids are very lightweight: they just hold the recipe to compute the new grid out of the old one, not the data itself. This means that we can generally afford to keep many such proxy objects loaded in memory. In a lot of cases, OpenRefine will indeed hold a Grid object for every single step of a project&#x27;s history. As a result, it becomes possible to undo a transformation even though Change objects do not support reverting their effects: we simply roll back to the earlier Grid object.</li>
<li>when the history grows longer, the project data is accessed via a long chain of proxy objects, meaning that the project workflow is re-executed many times. When that becomes too expensive, it is possible to turn on caching in one of the intermediate grids, meaning that we compute all the contents of that grid once and store that in memory or on disk. This strategy is detailed in the <a href="#memory-management">Memory management</a> section.</li>
<li>with lazy evaluation, some computations required by changes can be evaluated many times (for instance, each time facets are refreshed). This is undesirable for expensive or effectful computations (for instance, fetching data from a URL). To prevent this
from happening, changes are allowed to store the results of such expensive computations in <a href="#changedata-objects">ChangeData objects</a>. Such objects are evaluated only once, persisted on disk, and the new grid can be derived by combining the old grid with some ChangeData objects
(generally by joining them).</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar__YFU" id="changedata-objects">ChangeData objects<a href="#changedata-objects" class="hash-link" aria-label="Direct link to ChangeData objects" title="Direct link to ChangeData objects">​</a></h2>
<p>A <a href="https://javadoc-v4.openrefine.org/org/openrefine/model/changes/changedata" target="_blank" rel="noopener noreferrer">ChangeData</a> object is a data structure which holds change data which should be computed only once given the cost or side-effects of recomputing it multiple times. It is for
instance used to store reconciliation data, data fetched from URLs, or the results of evaluating expressions which are not guaranteed to be <a href="https://en.wikipedia.org/wiki/Pure_function" target="_blank" rel="noopener noreferrer">pure</a>.</p>
<p>ChangeData objects are able to index arbitrary data items associated to rows or records in a Grid. To each row or record id corresponds at most one such item.
The typical lifecycle for a ChangeData object is as follows:</p>
<ul>
<li>The ChangeData object is derived from a Grid by applying a function row or record-wise to the grid, using
<a href="https://javadoc-v4.openrefine.org/org/openrefine/model/grid#mapRows(org.openrefine.model.RowFilter,org.openrefine.model.changes.RowChangeDataProducer)" target="_blank" rel="noopener noreferrer">Grid::mapRows</a> or <a href="https://javadoc-v4.openrefine.org/org/openrefine/model/grid#mapRecords(org.openrefine.model.RecordFilter,org.openrefine.model.changes.RecordChangeDataProducer)" target="_blank" rel="noopener noreferrer">Grid::mapRecords</a>. This is typically a lazy operation, meaning that the expensive computations involved are not done yet;</li>
<li>Immediately after, it is saved to a file within the project&#x27;s storage directory (see <a href="#project-serialization">Project serialization</a>). This saving can take time as this triggers the expensive computations applied at the earlier step.</li>
<li>As soon as the saving has started (and while it is still in progress), the ChangeData can be read back from its serialization, using <a href="https://javadoc-v4.openrefine.org/org/openrefine/model/runner#loadChangeData(java.io.File,org.openrefine.model.changes.ChangeDataSerializer)" target="_blank" rel="noopener noreferrer">Runner.loadChangeData</a>. Only the items computed and written at that stage are read back.</li>
<li>The ChangeData can be joined back with the Grid it was derived from, inserting the change data into cells (for instance by creating a new column where fetched URLs are stored). This is done by means of methods such as
<a href="https://javadoc-v4.openrefine.org/org/openrefine/model/grid#join(org.openrefine.model.changes.ChangeData,org.openrefine.model.changes.RowChangeDataJoiner,org.openrefine.model.ColumnModel)" target="_blank" rel="noopener noreferrer">Grid::join</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar__YFU" id="project-serialization">Project serialization<a href="#project-serialization" class="hash-link" aria-label="Direct link to Project serialization" title="Direct link to Project serialization">​</a></h2>
<p>A single grid is serialized in its own directory, with the following components:</p>
<ul>
<li><code>metadata.json</code>, containing the column model and overlay models associated with the grid;</li>
<li><code>grid/part-*.gz</code> files, which are Gzip-compressed text files containing for each line the JSON serialization of a row in the project.</li>
</ul>
<p>The fact that the grid&#x27;s serialization is spread on multiple files makes it possible to process it in parallel (with one worker per partition). Rows are sorted and each partition contains a sequential chunk of rows, meaning that to access a given row by
row number, it is possible to read the relevant partition file only. The number of partitions depends on the size of the project and the options of the runner.</p>
<p>A project is serialized in its own directory too, with the following components:</p>
<ul>
<li><code>history.json</code>, containing the list of history entries, which includes the associated Changes and Operations;</li>
<li><code>initial/</code>, a directory where the first grid of the project (the one created by the importer) is stored;</li>
<li><code>changes/</code>, a directory where all the ChangeData objects are serialized. They are stored in subdirectories determined by the history entry id they are associated to.</li>
<li><code>cache/</code>, a directory where grids other than the initial one can be stored. This is useful when the project history grows longer to avoid recomputing all operations from the initial grid at every HTTP request.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar__YFU" id="memory-management">Memory management<a href="#memory-management" class="hash-link" aria-label="Direct link to Memory management" title="Direct link to Memory management">​</a></h2>
<p>TODO describe here the caching strategy (being reworked)</p>
<h2 class="anchor anchorWithStickyNavbar__YFU" id="local-runner">Local runner<a href="#local-runner" class="hash-link" aria-label="Direct link to Local runner" title="Direct link to Local runner">​</a></h2>
<p>The local runner is the default one, as it is designed to be efficient in OpenRefine&#x27;s intended usage conditions: running locally on the machine where the data cleaning is being done. Its design is inspired by Spark. Spark itself could not be used in place of this runner because its support for distributed computations and redundancy adds significant overheads which make the tool less responsive when run locally.
Also, OpenRefine relies on the order of rows in many contexts, and row order is not preserved by many Spark primitives, making its abstractions less useful for OpenRefine as default implementation.</p>
<h3 class="anchor anchorWithStickyNavbar__YFU" id="options">Options<a href="#options" class="hash-link" aria-label="Direct link to Options" title="Direct link to Options">​</a></h3>
<p>The following configuration parameters can be used with this runner:</p>
<table><thead><tr><th>Configuration key</th><th>Default value</th><th>Description</th></tr></thead><tbody><tr><td><code>refine.runner.defaultParallelism</code></td><td>4</td><td>how many partitions datasets should generally be split, unless they are very small or very big</td></tr><tr><td><code>refine.runner.minSplitSize</code></td><td>4096</td><td>minimum size of a partition in bytes. Datasets which are smaller than this value will not be split at all.</td></tr><tr><td><code>refine.runner.maxSplitSize</code></td><td>16777216</td><td>maximum size of a partition in bytes. Datasets which are larger than <code>defaultParallelism * maxSplitSize</code> will be split in more partitions than the default parallelism.</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar__YFU" id="partitioned-lazy-lists">Partitioned Lazy Lists<a href="#partitioned-lazy-lists" class="hash-link" aria-label="Direct link to Partitioned Lazy Lists" title="Direct link to Partitioned Lazy Lists">​</a></h3>
<p>The core data structure which underpins the lazy representation of Grids and ChangeData objects in the local runner is the Partitioned Lazy List (PLL).
It is a lightweight version of Spark&#x27;s <a href="https://spark.apache.org/docs/latest/rdd-programming-guide.html" target="_blank" rel="noopener noreferrer">Resilient Distributed Dataset (RDD)</a>. It is:</p>
<ul>
<li>a list, because it represents an ordered collections of objects;</li>
<li>lazy, because by default it does not store its contents as explicit objects in memory. Instead, the elements are computed on-demand, when they are accessed.</li>
<li>partitioned, because it divides its contents into contiguous groups of elements called partitions. Each partition can be enumerated from independently, making it possible to run processes in parallel on different parts of the list.</li>
</ul>
<p>In contrast to RDDs, PLLs are:</p>
<ul>
<li>not distributed: all of the data must be locally accessible, all the computations are happening in the same JVM</li>
<li>not resilient: there is no support for redundancy.</li>
</ul>
<p>The concurrency in PLLs is implemented with Java threads. When instantiated, the local runner starts a thread pool which is used on demand when computations are executed.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/OpenRefine/openrefine.github.com/edit/master/docs/technical-reference/architecture-4.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_AKM5" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_v_5u"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-02-27T14:48:08.000Z" itemprop="dateModified">Feb 27, 2023</time></b> by <b>Antonin Delpeuch</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/technical-reference/architecture-before-4"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Architecture before version 4</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/technical-reference/clustering-in-depth"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Clustering methods in-depth</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_kigY thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#project-history-structure" class="table-of-contents__link toc-highlight">Project history structure</a></li><li><a href="#runners" class="table-of-contents__link toc-highlight">Runners</a></li><li><a href="#lazy-and-eager-evaluation" class="table-of-contents__link toc-highlight">Lazy and eager evaluation</a></li><li><a href="#changedata-objects" class="table-of-contents__link toc-highlight">ChangeData objects</a></li><li><a href="#project-serialization" class="table-of-contents__link toc-highlight">Project serialization</a></li><li><a href="#memory-management" class="table-of-contents__link toc-highlight">Memory management</a></li><li><a href="#local-runner" class="table-of-contents__link toc-highlight">Local runner</a><ul><li><a href="#options" class="table-of-contents__link toc-highlight">Options</a></li><li><a href="#partitioned-lazy-lists" class="table-of-contents__link toc-highlight">Partitioned Lazy Lists</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Get OpenRefine</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/download">Download</a></li><li class="footer__item"><a class="footer__link-item" href="/whats_new">What&#x27;s new</a></li><li class="footer__item"><a class="footer__link-item" href="/extensions">Extensions</a></li><li class="footer__item"><a class="footer__link-item" href="/distributions">Other distributions</a></li><li class="footer__item"><a href="https://github.com/OpenRefine/OpenRefine" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub repository<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_RpKI"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">User manual</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/technical-reference/contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/external_resources">External resources</a></li><li class="footer__item"><a class="footer__link-item" href="/funding">Grants &amp; funding</a></li><li class="footer__item"><a class="footer__link-item" href="/privacy">Privacy notice</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/community">Get involved</a></li><li class="footer__item"><a href="https://forum.openrefine.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_RpKI"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitter.im/OpenRefine/OpenRefine" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter chat<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_RpKI"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/openrefine" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_RpKI"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item">
                  <a rel="me" class="footer__link-item" target="_blank" href="https://fosstodon.org/@OpenRefine">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_node_modules-@docusaurus-theme-classic-lib-theme-Icon-ExternalLink-styles-module"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a>
                </li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://openrefine.org" rel="noopener noreferrer" class="footerLogoLink_rbIq"><img src="/img/openrefine_logo.svg" alt="OpenRefine diamond logo" class="footer__logo themedComponent_vVmS themedComponent--light_NniB" height="150"><img src="/img/openrefine_logo.svg" alt="OpenRefine diamond logo" class="footer__logo themedComponent_vVmS themedComponent--dark_yJur" height="150"></a></div><div class="footer__copyright"><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png"></a><br>OpenRefine's documentation is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</div></div></div></footer></div>
</body>
</html>